<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="description" content="Free Web tutorials">
    <meta name="keywords" content="HTML,CSS,XML,JavaScript">
    <meta name="author" content="John Doe">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/css/w3.css">
    <link rel="stylesheet" href="./assets/css/main_style.css">
    <link rel="stylesheet" href="./assets/css/dropdown.css">
    <link rel="stylesheet" href="./assets/css/checkbox.css">
    <link rel="stylesheet" href="./assets/css/spinner.css">
    <script src="./assets/js/jquery-3.2.1.min.js"></script>
    <script src="./assets/js/reconnecting-websocket.min.js"></script>
    <title>WebSocket Client UI</title>
  </head>
  <body>
    <!-- The Modal -->
    <div id="loading-modal" class="w3-modal">
      <div class="w3-modal-content" style="background-color: transparent; padding-bottom:200px;">
        <div class="w3-container">
          <div class="loader"></div> <div class = "loading-text">Loading...</div>
        </div>
      </div>
    </div>
    <div class="w3-sidebar w3-bar-block w3-card"  id="mySidebar">
      <button class="w3-bar-item w3-button w3-large w3-padding-48 w3-center"><img src = "./assets/images/logo.png" class = "img-logo"></button>
        <a href="#" id = "changeModeItem" class="w3-bar-item w3-button w3-padding-32 w3-font-bold w3-center w3-bar-item-active">Change Mode</a>
        <a href="#" id = "scheduleItem" class="w3-bar-item w3-button w3-padding-32 w3-font-bold w3-center">Schedules</a>
        <a href="#" id = "addModeItem" class="w3-bar-item w3-button w3-padding-32 w3-font-bold w3-center">+ Mode</a>
      </div>      
      <div id="main">      
        <div class="w3-teal w3-title-bar">
          <div class="w3-container">
            <h2 id = 'content-title'>Change Mode</h2>
          </div>
        </div>        
        <div class="w3-container w3-content">          
        </div>      
      </div>      
      <script>
        var default_command = '';
        var default_option = '';
        var connectionState = false;
        var deviceList = new Array();
        var modeList = new Array();
        var socket;
        var lastScheduleIndex = 0;
        var menuItem = 0;          
        var selectedModeID = '';
        // var url = "ws://nodewebsocketserver.herokuapp.com";
        var url = "ws://localhost:3000";
        $(document).ready(function(){                    
          initSocket();
          $('#loading-modal').css('display', 'flex');
          $(document).click(function() {      
            $('.wrapper-dropdown-2').removeClass('active');
          });
          $("#changeModeItem").click(function(){
            if(menuItem != 0)
            {
              $("a").removeClass("w3-bar-item-active");
              $(this).addClass("w3-bar-item-active");
              $('#content-title').text('Change Mode');
              menuItem = 0;
            }
          });
          $("#scheduleItem").click(function(){
            if(menuItem != 1)
            {
              $("a").removeClass("w3-bar-item-active");
              $(this).addClass("w3-bar-item-active");
              $('#content-title').text('Schedules');
              menuItem = 1;
            }
          });
          $("#addModeItem").click(function(){
            if(menuItem != 2)
            {
              $("a").removeClass("w3-bar-item-active");
              $(this).addClass("w3-bar-item-active");
              $('#content-title').text('Add Mode');
              menuItem = 2;
            }
          });
          $(".w3-bar-item").click(function(){
            changeContent(menuItem);
          }); 
          changeContent(menuItem);                   
        });

        function buildChangeModeUI() {          
          for(var key in modeList) {
            var mode = modeList[key];
            var modeID = mode.mode_id;
            var command = mode.command;
            var defaultOption = mode.default_option;
            var imageName = "custom";
            if(mode.mode_type)
              imageName = modeID;
            $('#mode-list').append('<div class="w3-col m4 w3-center"> \
              <div id="' + modeID + '" class = "mode-round" default-command = "' + command + '" default-option = "' + defaultOption + '" img-name = "' + imageName + '"> \
                <div id="' + modeID + '_edit" class = "mode-edit">Edit</div> \
                <div class = "mode-image"><img id="' + modeID + '_image" src = "./assets/images/' + imageName + '.png"></div> \
                <div id="' + modeID + '_title" class = "mode-title">' + mode.mode_name + '</div> \
              </div> \
            </div>');
          }
          $(".mode-round").hover(function(){
            var id = $(this).attr('id');
            var imageName = $(this).attr('img-name');
            $("#" + id + "_edit").css('color', '#FFF');
            $("#" + id + "_title").css('color', '#FFF');
            $("#" + id + "_image").attr('src', './assets/images/' + imageName + '_selected.png');
          });
          $(".mode-round").mouseleave(function(){
            var id = $(this).attr('id');
            var imageName = $(this).attr('img-name');
            $("#" + id + "_edit").css('color', '#c3c3c3');
            $("#" + id + "_title").css('color', '#2b99d6');
            $("#" + id + "_image").attr('src', './assets/images/' + imageName + '.png');
          });
          $(".mode-round").click(function(){
            var defaultCommand = $(this).attr('default-command');
            var defaultOption = $(this).attr('default-option');
            if (typeof defaultCommand !== typeof undefined && defaultCommand !== false) {
              default_command = defaultCommand;                  
              default_option = defaultOption;
            } else {
              default_command = '';
              default_option = '';
            }
            var id = $(this).attr('id');
            selectedModeID = id;
            changeContent(3);
          });
          $('#loading-modal').css('display', 'none');
        }
        function changeContent(selectedMenuItem) {
          if(selectedMenuItem == 0) {
            $.get("change_mode.html", function(data) {
              $(".w3-content").html(data);  
              buildChangeModeUI();            
            });
          } else if(selectedMenuItem == 1) {
            $.get("schedule.html", function(data) {
              $(".w3-content").html(data);  
              for(i = 1; i < 5; i++) {
                addSchedule(i, 'All On', 'Monday', '9:00', 'AM');
                lastScheduleIndex = i;
              }              
              $('.add-button').click(function(){
                lastScheduleIndex ++;
                addSchedule(lastScheduleIndex, 'All On', 'Monday', '9:00', 'AM');
              });
            });
          } else if(selectedMenuItem == 2) {
            $.get("add_mode.html", function(data) {
              $(".w3-content").html(data);  
              var i = 1;
              new DropDown( $('#mode-command') );
              for(i = 1; i <= deviceList.length; i++) {
                $('#device-list tbody').append('<tr> \
                  <td></td> \
                  <td> \
                    <label class="container"><span class="device-name' + i + '">' + deviceList[i - 1] + '</span> \
                      <input id = "check_id' + i + '" type="checkbox" checked="checked"> \
                      <span class="checkmark"></span> \
                    </label> \
                  </td> \
                  <td> \
                    <div id="command-value' + i + '" class="wrapper-dropdown-2"><div id = "value">On</div> \
                      <ul class="dropdown"> \
                        <li><a href="#">On</a></li> \
                        <li><a href="#">Off</a></li> \
                      </ul> \
                    </div> \
                    <input id = "command-input-value' + i + '" class = "command-input-value" value = "https://www.google.com"> \
                  </td> \
                </tr>');
                new DropDown( $('#command-value' + i) );
                $('#command-input-value' + i).css('display', 'none');   
                $('#command-value' + i + ' .dropdown li').on("click", {value: i}, function(event) {      
                  $('#command-value' + event.data.value + ' #value').text($(this).text());
                });
                $('#check_id' + i).click(function() {
                  var attr = $(this).attr('checked');
                  if (typeof attr !== typeof undefined && attr !== false) {
                    $(this).removeAttr('checked');
                  } else {
                    $(this).attr('checked', 'checked');
                  }
                });
              }                                                     
              $('#mode-command .dropdown li').on("click", {value: i}, function(event) {      
                $('#mode-command #value').text($(this).text());
                for(i = 1; i <= deviceList.length; i++) {
                  if($(this).text() == 'Toggle Status') {
                    $('#command-input-value' + i).css('display', 'none');
                    $('#command-value' + i).css('display', 'inline-block');
                  } else {
                    $('#command-input-value' + i).css('display', 'inline-block');
                    $('#command-value' + i).css('display', 'none');
                  }
                }                                  
              });              
              $('.save-button').click(function(){                
                saveMode();
              });
            });
          } else if(selectedMenuItem == 3) {
            $('#content-title').text('Edit Mode');
            $.get("edit_mode.html", function(data) {
              $(".w3-content").html(data);              
              for(i = 1; i <= deviceList.length; i++) {
                $('#device-list tbody').append('<tr><td id="device-name' + i + '">Jill</td> \
                  <td> \
                    <div id="command-category' + i + '" class="wrapper-dropdown-2"><div id = "value">Toggle Status</div> \
                      <ul class="dropdown"> \
                        <li><a href="#">Toggle Status</a></li> \
                        <li><a href="#">Open URL</a></li> \
                      </ul> \
                    </div> \
                  </td> \
                  <td> \
                    <div id="command-value' + i + '" class="wrapper-dropdown-2"><div id = "value">On</div> \
                      <ul class="dropdown"> \
                        <li><a href="#">On</a></li> \
                        <li><a href="#">Off</a></li> \
                      </ul> \
                    </div> \
                    <input id = "command-input-value' + i + '" class = "command-input-value" value = "https://www.google.com">\
                  </td></tr>');
                  $('#device-name' + i).html(deviceList[i - 1]);
                  if(default_command == '') {
                    new DropDown( $('#command-category' + i) );
                    new DropDown( $('#command-value' + i) );
                    $('#command-input-value' + i).css('display', 'none');
                  } else {
                    $('#command-category' + i + ' #value').text(default_command);
                    if(default_command == 'Toggle Status') {
                      $('#command-input-value' + i).css('display', 'none');
                      $('#command-value' + i).css('display', 'inline-block');
                      $('#command-value' + i + ' #value').text(default_option);
                      $('.save-button').css('display', 'none');
                    } else {
                      $('#command-input-value' + i).css('display', 'inline-block');
                      $('#command-value' + i).css('display', 'none');
                      $('#command-input-value' + i).val(default_option);
                      $('.save-button').css('display', 'inline-block');
                    }                                       
                  }
                  $('#command-category' + i + ' .dropdown li').on("click", {value: i}, function(event) {      
                    $('#command-category' + event.data.value + ' #value').text($(this).text());
                    if($(this).text() == 'Toggle Status') {
                      $('#command-input-value' + event.data.value).css('display', 'none');
                      $('#command-value' + event.data.value).css('display', 'inline-block');
                    } else {
                      $('#command-input-value' + event.data.value).css('display', 'inline-block');
                      $('#command-value' + event.data.value).css('display', 'none');
                    }
                  });
                  $('#command-value' + i + ' .dropdown li').on("click", {value: i}, function(event) {      
                    $('#command-value' + event.data.value + ' #value').text($(this).text());
                  });
              }
              if(selectedModeID != '' && selectedModeID != undefined) {                
                var title = selectedModeID;
                title = title.replace('_', ' ');
                title = title.charAt(0).toUpperCase() + title.slice(1);      
                $('.edit-mode-title').text(title);      
                $('.edit-mode-logo-image').attr('src', './assets/images/' + selectedModeID + '.png');          
              }
            });
          }
        }
        function DropDown(el) {
          this.dd = el;
          this.initEvents();
        }
        DropDown.prototype = {
          initEvents : function() {
            var obj = this;
            obj.dd.on('click', function(event){
                $(this).toggleClass('active');
                event.stopPropagation();
            }); 
          }
        }
        function addSchedule(index, modeName, day, schedule_time, schedule_timepart) {
          $('#schedule-list tbody').append('<tr> \
            <td> \
              <div id="mode-category' + index + '" class="wrapper-dropdown-2"><div id = "value">All On</div> \
                <ul class="dropdown"> \
                </ul> \
              </div> \
            </td> \
            <td> \
              <div id="schedule-day' + index + '" class="wrapper-dropdown-2"><div id = "value">Monday</div> \
                <ul class="dropdown"> \
                  <li><a href="#">Monday</a></li> \
                  <li><a href="#">Tuesday</a></li> \
                  <li><a href="#">Wednesday</a></li> \
                  <li><a href="#">Thursday</a></li> \
                  <li><a href="#">Friday</a></li> \
                  <li><a href="#">Saturday</a></li> \
                  <li><a href="#">Sunday</a></li> \
                </ul> \
              </div> \
            </td> \
            <td> \
              <div id="schedule-time' + index + '" class="wrapper-dropdown-2 schedule-time"><div id = "value">9:00</div> \
                <ul class="dropdown"> \
                  <li><a href="#">1:00</a></li> \
                  <li><a href="#">2:00</a></li> \
                  <li><a href="#">3:00</a></li> \
                  <li><a href="#">4:00</a></li> \
                  <li><a href="#">5:00</a></li> \
                  <li><a href="#">6:00</a></li> \
                  <li><a href="#">7:00</a></li> \
                  <li><a href="#">8:00</a></li> \
                  <li><a href="#">9:00</a></li> \
                  <li><a href="#">10:00</a></li> \
                  <li><a href="#">11:00</a></li> \
                  <li><a href="#">12:00</a></li> \
                </ul> \
              </div> \
              <div id="schedule-timepart' + index + '" class="wrapper-dropdown-2 schedule-time"><div id = "value">AM</div> \
                <ul class="dropdown"> \
                  <li><a href="#">AM</a></li> \
                  <li><a href="#">PM</a></li> \
                </ul> \
              </div> \
            </td> \
          </tr>');
          for(var key in modeList) {
            $('#mode-category' + index + ' ul').append('<li><a href="#">' + modeList[key] + '</a></li>');
          }
          new DropDown( $('#mode-category' + index) );
          new DropDown( $('#schedule-day' + index) );
          new DropDown( $('#schedule-time' + index) );
          new DropDown( $('#schedule-timepart' + index) );
          $('#mode-category' + index + ' .dropdown li').on("click", {value: index}, function(event) {      
            $('#mode-category' + event.data.value + ' #value').text($(this).text());
          });
          $('#schedule-day' + index + ' .dropdown li').on("click", {value: index}, function(event) {      
            $('#schedule-day' + event.data.value + ' #value').text($(this).text());
          });
          $('#schedule-time' + index + ' .dropdown li').on("click", {value: index}, function(event) {      
            $('#schedule-time' + event.data.value + ' #value').text($(this).text());
          });
          $('#schedule-timepart' + index + ' .dropdown li').on("click", {value: index}, function(event) {      
            $('#schedule-timepart' + event.data.value + ' #value').text($(this).text());
          });
        }
        function saveMode() {
          var modeName = '';
          var modeID = '';
          var modeCommand = '';
          var mode_detail = {};
          if($('#mode-name').val() == '') {
            alert('Please Input Mode Name');
            return;
          } else {
            modeName = $('#mode-name').val();
            modeID = modeName;
            var i = 0, strLength = modeID.length;
            for(i; i < strLength; i++) {            
              modeID = modeID.replace(" ", "");            
            }
            modeID = modeID.toLowerCase();
            modeCommand = $('#mode-command #value').text();
            mode_detail.mode_name = modeName;
            mode_detail.mode_id = modeID;
            mode_detail.mode_command = modeCommand;
            mode_detail.mode_type = false;            
          }
          var deviceArray = new Array();
          for(i = 1; i <= deviceList.length; i++) {
            var deviceInfo = {};
            var attr = $('#check_id' + i).attr('checked');
            if (typeof attr !== typeof undefined && attr !== false) {
              console.log();
              deviceInfo.device_name = $('.device-name' + i).text();
              if(modeCommand == 'Toggle Status')
                deviceInfo.option_value = $('#command-value' + i + " #value").text();                
              else
                deviceInfo.option_value = $('#command-input-value' + i).val();
                deviceArray.push(deviceInfo); 
            }
          }
          mode_detail.device_list = deviceArray;   
          mode_detail.action = "add_mode";               
          socket.send(JSON.stringify(mode_detail));       
        }
        function initSocket() {
          socket = new ReconnectingWebSocket(url);    
          socket.onerror = function(msg) {                
          }
          socket.onclose = function(msg) {
          }
          socket.onopen = function () {
            connectionState = true;
            var message = {};
            message.action = "register_webui";               
            socket.send(JSON.stringify(message));
          };
          socket.onmessage = function (msg) {  
            var message = JSON.parse(msg.data);
            if (message.action == "init_devices") {
              deviceList = message.device_list;
              modeList = message.mode_list;
              if(menuItem == 0)
                buildChangeModeUI();
              console.log(modeList);
              console.log(deviceList);
            } else if (message.action == "add_mode_callback") {
              if(message.error == false) {
                var newMode = message.added_mode;
                modeList[newMode.mode_id] = newMode;
                console.log(modeList);
              } else {
                alert(message.comment);
              }
            }
          };    
        }
      </script>
  </body>
</html>